# yaml-language-server: $schema=https://json.schemastore.org/github-workflow.json
name: Build and Deploy to Azure App Service

on:
  push:
    branches:
      - main
    paths:
      - 'src/App/**'
      - 'src/api/python/**'
      - 'infra/scripts/agent_scripts/agents/**'
      - '.github/workflows/deploy-app-service.yml'
  pull_request:
    types: [opened, synchronize, reopened]
    branches:
      - main
    paths:
      - 'src/App/**'
      - 'src/api/python/**'
  workflow_dispatch:
    inputs:
      deploy_frontend:
        description: 'Deploy Frontend'
        type: boolean
        default: true
      deploy_api:
        description: 'Deploy API'
        type: boolean
        default: true
      environment:
        description: 'Environment to deploy'
        type: choice
        options:
          - dev
          - staging
          - prod
        default: 'dev'

env:
  # Azure Container Registry
  ACR_LOGIN_SERVER: ${{ secrets.ACR_LOGIN_SERVER || 'crda672axowukix3.azurecr.io' }}
  # App Service names
  FRONTEND_APP_NAME: ${{ vars.FRONTEND_APP_NAME || 'app-daj6dri4yf3k3z' }}
  API_APP_NAME: ${{ vars.API_APP_NAME || 'api-daj6dri4yf3k3z' }}
  RESOURCE_GROUP: ${{ vars.RESOURCE_GROUP || 'rg-agent-unified-data-acce-eastus-001' }}

permissions:
  contents: read
  id-token: write
  actions: read
  pull-requests: write

jobs:
  # ============================================
  # Run Tests First (Gate for Deployment)
  # ============================================
  run-tests:
    name: Run Tests (Gate)
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: src/api/python
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install uv
        run: pip install uv

      - name: Install dependencies
        run: |
          uv pip install --system -r requirements.txt
          uv pip install --system -r requirements-test.txt

      - name: Run Ruff lint
        run: ruff check .

      - name: Run unit tests
        run: |
          pytest tests/ -v --tb=short -m "not slow"
        env:
          AZURE_AI_AGENT_ENDPOINT: "https://test.openai.azure.com/"
          AZURE_OPENAI_ENDPOINT: "https://test.openai.azure.com/"
          AZURE_OPENAI_API_KEY: "test-key"
          FABRIC_SQL_CONNECTION_STRING: "Driver={ODBC Driver 18 for SQL Server};Server=test;Database=test;"
          APPLICATIONINSIGHTS_CONNECTION_STRING: ""

  # ============================================
  # Detect Changes
  # ============================================
  detect-changes:
    runs-on: ubuntu-latest
    needs: run-tests  # Tests must pass before detecting changes
    outputs:
      frontend_changed: ${{ steps.changes.outputs.frontend }}
      api_changed: ${{ steps.changes.outputs.api }}
      agents_changed: ${{ steps.changes.outputs.agents }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Detect changes
        uses: dorny/paths-filter@v3
        id: changes
        with:
          filters: |
            frontend:
              - 'src/App/**'
            api:
              - 'src/api/python/**'
            agents:
              - 'infra/scripts/agent_scripts/agents/**'
              - 'infra/scripts/agent_scripts/config.yaml'

  # ============================================
  # Build Frontend
  # ============================================
  build-frontend:
    runs-on: ubuntu-latest
    needs: detect-changes
    if: >-
      needs.detect-changes.outputs.frontend_changed == 'true' ||
      (github.event_name == 'workflow_dispatch' && github.event.inputs.deploy_frontend == 'true')
    outputs:
      image_tag: ${{ steps.meta.outputs.version }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Azure Container Registry
        if: github.event_name != 'pull_request'
        uses: azure/docker-login@v2
        with:
          login-server: ${{ env.ACR_LOGIN_SERVER }}
          username: ${{ secrets.ACR_USERNAME }}
          password: ${{ secrets.ACR_PASSWORD }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.ACR_LOGIN_SERVER }}/da-app
          tags: |
            type=sha,prefix=,format=short
            type=ref,event=branch
            type=raw,value=latest,enable=${{ github.ref == 'refs/heads/main' }}

      - name: Build and push Frontend Docker image
        id: build-frontend
        uses: docker/build-push-action@v6
        with:
          context: ./src/App
          file: ./src/App/WebApp.Dockerfile
          push: ${{ github.event_name != 'pull_request' }}
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          load: ${{ github.event_name == 'pull_request' }}

      - name: Run Trivy vulnerability scanner (Frontend)
        if: github.event_name == 'pull_request'
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: '${{ env.ACR_LOGIN_SERVER }}/da-app:${{ steps.meta.outputs.version }}'
          format: 'table'
          exit-code: '0'
          severity: 'CRITICAL,HIGH'

      - name: Output image info
        run: |
          echo "### ðŸ–¼ï¸ Frontend Image Built" >> $GITHUB_STEP_SUMMARY
          echo "- Image: \`${{ env.ACR_LOGIN_SERVER }}/da-app\`" >> $GITHUB_STEP_SUMMARY
          echo "- Tag: \`${{ steps.meta.outputs.version }}\`" >> $GITHUB_STEP_SUMMARY

  # ============================================
  # Build API
  # ============================================
  build-api:
    runs-on: ubuntu-latest
    needs: detect-changes
    if: >-
      needs.detect-changes.outputs.api_changed == 'true' ||
      (github.event_name == 'workflow_dispatch' && github.event.inputs.deploy_api == 'true')
    outputs:
      image_tag: ${{ steps.meta.outputs.version }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Azure Container Registry
        if: github.event_name != 'pull_request'
        uses: azure/docker-login@v2
        with:
          login-server: ${{ env.ACR_LOGIN_SERVER }}
          username: ${{ secrets.ACR_USERNAME }}
          password: ${{ secrets.ACR_PASSWORD }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.ACR_LOGIN_SERVER }}/da-api
          tags: |
            type=sha,prefix=,format=short
            type=ref,event=branch
            type=raw,value=latest,enable=${{ github.ref == 'refs/heads/main' }}

      - name: Build and push API Docker image
        id: build-api
        uses: docker/build-push-action@v6
        with:
          context: ./src/api/python
          file: ./src/api/python/ApiApp.Dockerfile
          push: ${{ github.event_name != 'pull_request' }}
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          load: ${{ github.event_name == 'pull_request' }}

      - name: Run Trivy vulnerability scanner (API)
        if: github.event_name == 'pull_request'
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: '${{ env.ACR_LOGIN_SERVER }}/da-api:${{ steps.meta.outputs.version }}'
          format: 'table'
          exit-code: '0'
          severity: 'CRITICAL,HIGH'

      - name: Output image info
        run: |
          echo "### ðŸ–¼ï¸ API Image Built" >> $GITHUB_STEP_SUMMARY
          echo "- Image: \`${{ env.ACR_LOGIN_SERVER }}/da-api\`" >> $GITHUB_STEP_SUMMARY
          echo "- Tag: \`${{ steps.meta.outputs.version }}\`" >> $GITHUB_STEP_SUMMARY

  # ============================================
  # Deploy Frontend to App Service
  # ============================================
  deploy-frontend:
    runs-on: ubuntu-latest
    needs: build-frontend
    if: github.event_name != 'pull_request' && github.ref == 'refs/heads/main'
    environment:
      name: ${{ github.event.inputs.environment || 'dev' }}
      url: ${{ steps.deploy.outputs.webapp-url }}
    steps:
      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Deploy to Azure App Service (Frontend)
        id: deploy
        uses: azure/webapps-deploy@v3
        with:
          app-name: ${{ env.FRONTEND_APP_NAME }}
          images: ${{ env.ACR_LOGIN_SERVER }}/da-app:${{ needs.build-frontend.outputs.image_tag }}

      - name: Output deployment info
        run: |
          echo "### ðŸš€ Frontend Deployed" >> $GITHUB_STEP_SUMMARY
          echo "- App Service: \`${{ env.FRONTEND_APP_NAME }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- Image: \`${{ env.ACR_LOGIN_SERVER }}/da-app:${{ needs.build-frontend.outputs.image_tag }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- URL: ${{ steps.deploy.outputs.webapp-url }}" >> $GITHUB_STEP_SUMMARY

  # ============================================
  # Deploy API to App Service
  # ============================================
  deploy-api:
    runs-on: ubuntu-latest
    needs: build-api
    if: github.event_name != 'pull_request' && github.ref == 'refs/heads/main'
    environment:
      name: ${{ github.event.inputs.environment || 'dev' }}
      url: ${{ steps.deploy.outputs.webapp-url }}
    steps:
      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Deploy to Azure App Service (API)
        id: deploy
        uses: azure/webapps-deploy@v3
        with:
          app-name: ${{ env.API_APP_NAME }}
          images: ${{ env.ACR_LOGIN_SERVER }}/da-api:${{ needs.build-api.outputs.image_tag }}

      - name: Output deployment info
        run: |
          echo "### ðŸš€ API Deployed" >> $GITHUB_STEP_SUMMARY
          echo "- App Service: \`${{ env.API_APP_NAME }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- Image: \`${{ env.ACR_LOGIN_SERVER }}/da-api:${{ needs.build-api.outputs.image_tag }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- URL: ${{ steps.deploy.outputs.webapp-url }}" >> $GITHUB_STEP_SUMMARY

  # ============================================
  # Post-deployment Health Check
  # ============================================
  health-check:
    runs-on: ubuntu-latest
    needs: [deploy-frontend, deploy-api]
    if: always() && (needs.deploy-frontend.result == 'success' || needs.deploy-api.result == 'success')
    steps:
      - name: Wait for deployment to stabilize
        run: sleep 60

      - name: Health check - Frontend
        if: needs.deploy-frontend.result == 'success'
        run: |
          FRONTEND_URL="https://${{ env.FRONTEND_APP_NAME }}.azurewebsites.net"
          echo "Checking Frontend: $FRONTEND_URL"
          HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$FRONTEND_URL" --max-time 30 || echo "000")
          echo "Frontend HTTP Status: $HTTP_STATUS"
          if [[ "$HTTP_STATUS" == "200" || "$HTTP_STATUS" == "302" ]]; then
            echo "âœ… Frontend is healthy"
          else
            echo "âš ï¸ Frontend returned status: $HTTP_STATUS"
          fi

      - name: Health check - API
        if: needs.deploy-api.result == 'success'
        run: |
          API_URL="https://${{ env.API_APP_NAME }}.azurewebsites.net/health"
          echo "Checking API: $API_URL"
          HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$API_URL" --max-time 30 || echo "000")
          echo "API HTTP Status: $HTTP_STATUS"
          if [[ "$HTTP_STATUS" == "200" ]]; then
            echo "âœ… API is healthy"
          else
            echo "âš ï¸ API returned status: $HTTP_STATUS (might need endpoint check)"
          fi

      - name: Summary
        run: |
          echo "### ðŸ¥ Health Check Results" >> $GITHUB_STEP_SUMMARY
          echo "- Frontend: https://${{ env.FRONTEND_APP_NAME }}.azurewebsites.net" >> $GITHUB_STEP_SUMMARY
          echo "- API: https://${{ env.API_APP_NAME }}.azurewebsites.net" >> $GITHUB_STEP_SUMMARY

  # ============================================
  # Update Microsoft Foundry Agents
  # ============================================
  update-agents:
    runs-on: ubuntu-latest
    needs: [detect-changes, deploy-api]
    if: |
      always() &&
      github.event_name != 'pull_request' &&
      github.ref == 'refs/heads/main' &&
      (needs.detect-changes.outputs.agents_changed == 'true' || needs.deploy-api.result == 'success')
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'
          cache-dependency-path: 'infra/scripts/agent_scripts/requirements.txt'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r infra/scripts/agent_scripts/requirements.txt

      - name: Update Microsoft Foundry Agents
        env:
          AZURE_AI_AGENT_ENDPOINT: ${{ secrets.AZURE_AI_AGENT_ENDPOINT || 'https://aisa-daj6dri4yf3k3z.services.ai.azure.com/api/projects/aifp-daj6dri4yf3k3z' }}
          SOLUTION_NAME: ${{ vars.SOLUTION_NAME || 'daj6dri4yf3k3z' }}
          AZURE_AI_AGENT_MODEL_DEPLOYMENT_NAME: ${{ vars.AZURE_AI_AGENT_MODEL_DEPLOYMENT_NAME || 'gpt-5' }}
          USE_CASE: ${{ vars.USE_CASE || 'retail' }}
          API_APP_NAME: ${{ env.API_APP_NAME }}
          AZURE_RESOURCE_GROUP: ${{ env.RESOURCE_GROUP }}
        run: |
          python infra/scripts/agent_scripts/create_agents.py \
            --ai_project_endpoint="${AZURE_AI_AGENT_ENDPOINT}" \
            --solution_name="${SOLUTION_NAME}" \
            --gpt_model_name="${AZURE_AI_AGENT_MODEL_DEPLOYMENT_NAME}" \
            --usecase="${USE_CASE}"

      - name: Update App Service Agent Names
        env:
          AZURE_AI_AGENT_ENDPOINT: ${{ secrets.AZURE_AI_AGENT_ENDPOINT || 'https://aisa-daj6dri4yf3k3z.services.ai.azure.com/api/projects/aifp-daj6dri4yf3k3z' }}
          SOLUTION_NAME: ${{ vars.SOLUTION_NAME || 'daj6dri4yf3k3z' }}
        run: |
          CHAT_AGENT_NAME="ChatAgent-${SOLUTION_NAME}"
          TITLE_AGENT_NAME="TitleAgent-${SOLUTION_NAME}"

          az webapp config appsettings set \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --name ${{ env.API_APP_NAME }} \
            --settings AGENT_NAME_CHAT="$CHAT_AGENT_NAME" AGENT_NAME_TITLE="$TITLE_AGENT_NAME" \
            --output none

          echo "### ðŸ¤– Agents Updated" >> $GITHUB_STEP_SUMMARY
          echo "- ChatAgent: \`$CHAT_AGENT_NAME\`" >> $GITHUB_STEP_SUMMARY
          echo "- TitleAgent: \`$TITLE_AGENT_NAME\`" >> $GITHUB_STEP_SUMMARY
