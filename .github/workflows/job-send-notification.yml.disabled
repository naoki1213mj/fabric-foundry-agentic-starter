name: Send Notification Job

on:
  workflow_call:
    inputs:
      trigger_type:
        description: 'Trigger type (workflow_dispatch, pull_request, schedule)'
        required: true
        type: string
      BACKEND_RUNTIME_STACK:
        description: 'Specify the backend runtime stack (python/dotnet)'
        type: 'string'
        required: false
        default: 'python'
      EXP:
        description: 'Enable EXP'
        required: false
        default: false
        type: boolean
      run_e2e_tests:
        description: 'Run End-to-End Tests'
        required: false
        default: 'GoldenPath-Testing'
        type: string
      existing_webapp_url:
        description: 'Existing Container WebApp URL (Skips Deployment)'
        required: false
        default: ''
        type: string
      deploy_result:
        description: 'Deploy job result (success, failure, skipped)'
        required: true
        type: string
      e2e_test_result:
        description: 'E2E test job result (success, failure, skipped)'
        required: true
        type: string
      WEB_APPURL:
        description: 'Container Web App URL'
        required: false
        default: ''
        type: string
      RESOURCE_GROUP_NAME:
        description: 'Resource Group Name'
        required: false
        default: ''
        type: string
      QUOTA_FAILED:
        description: 'Quota Check Failed Flag'
        required: false
        default: 'false'
        type: string
      TEST_SUCCESS:
        description: 'Test Success Flag'
        required: false
        default: ''
        type: string
      TEST_REPORT_URL:
        description: 'Test Report URL'
        required: false
        default: ''
        type: string

env:
  GPT_MIN_CAPACITY: 100
  BRANCH_NAME: ${{ github.event.workflow_run.head_branch || github.head_ref || github.ref_name }}
  BACKEND_RUNTIME_STACK: ${{ inputs.trigger_type == 'workflow_dispatch' && (inputs.BACKEND_RUNTIME_STACK || 'python') || 'python' }}
  EXP: ${{ inputs.trigger_type == 'workflow_dispatch' && (inputs.EXP || false) || false }}
  RUN_E2E_TESTS: ${{ inputs.trigger_type == 'workflow_dispatch' && (inputs.run_e2e_tests || 'GoldenPath-Testing') || 'GoldenPath-Testing' }}

permissions:
  contents: read
  actions: read
  
jobs:
  send-notification:
    runs-on: ubuntu-latest
    continue-on-error: true
    env:
      accelerator_name: "Fabric SQL"
    steps:
      - name: Validate Workflow Input Parameters
        shell: bash
        env:
          INPUT_BACKEND_RUNTIME_STACK: ${{ inputs.BACKEND_RUNTIME_STACK }}
          INPUT_EXP: ${{ inputs.EXP }}
          INPUT_RUN_E2E_TESTS: ${{ inputs.run_e2e_tests }}
          INPUT_EXISTING_WEBAPP_URL: ${{ inputs.existing_webapp_url }}
          INPUT_DEPLOY_RESULT: ${{ inputs.deploy_result }}
          INPUT_E2E_TEST_RESULT: ${{ inputs.e2e_test_result }}
          INPUT_WEB_APPURL: ${{ inputs.WEB_APPURL }}
          INPUT_RESOURCE_GROUP_NAME: ${{ inputs.RESOURCE_GROUP_NAME }}
          INPUT_QUOTA_FAILED: ${{ inputs.QUOTA_FAILED }}
          INPUT_TEST_SUCCESS: ${{ inputs.TEST_SUCCESS }}
          INPUT_TEST_REPORT_URL: ${{ inputs.TEST_REPORT_URL }}
        run: |
          echo "üîç Validating workflow input parameters..."
          VALIDATION_FAILED=false
          
          # Validate BACKEND_RUNTIME_STACK (optional, must be 'python' or 'dotnet' if provided)
          if [[ -n "$INPUT_BACKEND_RUNTIME_STACK" ]]; then
            if [[ "$INPUT_BACKEND_RUNTIME_STACK" != "python" && "$INPUT_BACKEND_RUNTIME_STACK" != "dotnet" ]]; then
              echo "‚ùå ERROR: BACKEND_RUNTIME_STACK must be 'python' or 'dotnet', got: '$INPUT_BACKEND_RUNTIME_STACK'"
              VALIDATION_FAILED=true
            else
              echo "‚úÖ BACKEND_RUNTIME_STACK: '$INPUT_BACKEND_RUNTIME_STACK' is valid"
            fi
          fi
          
          # Validate EXP (boolean)
          if [[ "$INPUT_EXP" != "true" && "$INPUT_EXP" != "false" ]]; then
            echo "‚ùå ERROR: EXP must be 'true' or 'false', got: '$INPUT_EXP'"
            VALIDATION_FAILED=true
          else
            echo "‚úÖ EXP: '$INPUT_EXP' is valid"
          fi
          
          # Validate run_e2e_tests (specific allowed values)
          if [[ -n "$INPUT_RUN_E2E_TESTS" ]]; then
            ALLOWED_VALUES=("None" "GoldenPath-Testing" "Smoke-Testing")
            if [[ ! " ${ALLOWED_VALUES[@]} " =~ " ${INPUT_RUN_E2E_TESTS} " ]]; then
              echo "‚ùå ERROR: run_e2e_tests '$INPUT_RUN_E2E_TESTS' is invalid. Allowed values: ${ALLOWED_VALUES[*]}"
              VALIDATION_FAILED=true
            else
              echo "‚úÖ run_e2e_tests: '$INPUT_RUN_E2E_TESTS' is valid"
            fi
          fi
          
          # Validate existing_webapp_url (must start with https if provided)
          if [[ -n "$INPUT_EXISTING_WEBAPP_URL" ]]; then
            if [[ ! "$INPUT_EXISTING_WEBAPP_URL" =~ ^https:// ]]; then
              echo "‚ùå ERROR: existing_webapp_url must start with 'https://', got: '$INPUT_EXISTING_WEBAPP_URL'"
              VALIDATION_FAILED=true
            else
              echo "‚úÖ existing_webapp_url: '$INPUT_EXISTING_WEBAPP_URL' is valid"
            fi
          fi
          
          # Validate deploy_result (must be specific values if provided)
          if [[ -n "$INPUT_DEPLOY_RESULT" ]]; then
            ALLOWED_DEPLOY_RESULTS=("success" "failure" "skipped")
            if [[ ! " ${ALLOWED_DEPLOY_RESULTS[@]} " =~ " ${INPUT_DEPLOY_RESULT} " ]]; then
              echo "‚ùå ERROR: deploy_result '$INPUT_DEPLOY_RESULT' is invalid. Allowed values: ${ALLOWED_DEPLOY_RESULTS[*]}"
              VALIDATION_FAILED=true
            else
              echo "‚úÖ deploy_result: '$INPUT_DEPLOY_RESULT' is valid"
            fi
          fi
          
          # Validate e2e_test_result (must be specific values if provided)
          if [[ -n "$INPUT_E2E_TEST_RESULT" ]]; then
            ALLOWED_TEST_RESULTS=("success" "failure" "skipped")
            if [[ ! " ${ALLOWED_TEST_RESULTS[@]} " =~ " ${INPUT_E2E_TEST_RESULT} " ]]; then
              echo "‚ùå ERROR: e2e_test_result '$INPUT_E2E_TEST_RESULT' is invalid. Allowed values: ${ALLOWED_TEST_RESULTS[*]}"
              VALIDATION_FAILED=true
            else
              echo "‚úÖ e2e_test_result: '$INPUT_E2E_TEST_RESULT' is valid"
            fi
          fi
          
          # Validate WEB_APPURL (must start with https if provided)
          if [[ -n "$INPUT_WEB_APPURL" ]]; then
            if [[ ! "$INPUT_WEB_APPURL" =~ ^https:// ]]; then
              echo "‚ùå ERROR: WEB_APPURL must start with 'https://', got: '$INPUT_WEB_APPURL'"
              VALIDATION_FAILED=true
            else
              echo "‚úÖ WEB_APPURL: '$INPUT_WEB_APPURL' is valid"
            fi
          fi
          
          # Validate RESOURCE_GROUP_NAME (Azure resource group naming convention if provided)
          if [[ -n "$INPUT_RESOURCE_GROUP_NAME" ]]; then
            if [[ ! "$INPUT_RESOURCE_GROUP_NAME" =~ ^[a-zA-Z0-9._\(\)-]+$ ]] || [[ "$INPUT_RESOURCE_GROUP_NAME" =~ \.$ ]]; then
              echo "‚ùå ERROR: RESOURCE_GROUP_NAME '$INPUT_RESOURCE_GROUP_NAME' is invalid. Must contain only alphanumerics, periods, underscores, hyphens, and parentheses. Cannot end with period."
              VALIDATION_FAILED=true
            elif [[ ${#INPUT_RESOURCE_GROUP_NAME} -gt 90 ]]; then
              echo "‚ùå ERROR: RESOURCE_GROUP_NAME '$INPUT_RESOURCE_GROUP_NAME' exceeds 90 characters"
              VALIDATION_FAILED=true
            else
              echo "‚úÖ RESOURCE_GROUP_NAME: '$INPUT_RESOURCE_GROUP_NAME' is valid"
            fi
          fi
          
          # Validate QUOTA_FAILED (must be 'true', 'false', or empty string)
          if [[ "$INPUT_QUOTA_FAILED" != "true" && "$INPUT_QUOTA_FAILED" != "false" && "$INPUT_QUOTA_FAILED" != "" ]]; then
            echo "‚ùå ERROR: QUOTA_FAILED must be 'true', 'false', or empty string, got: '$INPUT_QUOTA_FAILED'"
            VALIDATION_FAILED=true
          else
            echo "‚úÖ QUOTA_FAILED: '$INPUT_QUOTA_FAILED' is valid"
          fi
          
          # Validate TEST_SUCCESS (must be 'true' or 'false' or empty)
          if [[ -n "$INPUT_TEST_SUCCESS" ]]; then
            if [[ "$INPUT_TEST_SUCCESS" != "true" && "$INPUT_TEST_SUCCESS" != "false" ]]; then
              echo "‚ùå ERROR: TEST_SUCCESS must be 'true', 'false', or empty, got: '$INPUT_TEST_SUCCESS'"
              VALIDATION_FAILED=true
            else
              echo "‚úÖ TEST_SUCCESS: '$INPUT_TEST_SUCCESS' is valid"
            fi
          fi
          
          # Validate TEST_REPORT_URL (must start with https if provided)
          if [[ -n "$INPUT_TEST_REPORT_URL" ]]; then
            if [[ ! "$INPUT_TEST_REPORT_URL" =~ ^https:// ]]; then
              echo "‚ùå ERROR: TEST_REPORT_URL must start with 'https://', got: '$INPUT_TEST_REPORT_URL'"
              VALIDATION_FAILED=true
            else
              echo "‚úÖ TEST_REPORT_URL: '$INPUT_TEST_REPORT_URL' is valid"
            fi
          fi
          
          # Fail workflow if any validation failed
          if [[ "$VALIDATION_FAILED" == "true" ]]; then
            echo ""
            echo "‚ùå Parameter validation failed. Please correct the errors above and try again."
            exit 1
          fi
          
          echo ""
          echo "‚úÖ All input parameters validated successfully!"

      - name: Determine Test Suite Display Name
        id: test_suite
        shell: bash
        env:
          ENV_RUN_E2E_TESTS: ${{ env.RUN_E2E_TESTS }}
        run: |
          if [ "$ENV_RUN_E2E_TESTS" = "GoldenPath-Testing" ]; then
            TEST_SUITE_NAME="Golden Path Testing"
          elif [ "$ENV_RUN_E2E_TESTS" = "Smoke-Testing" ]; then
            TEST_SUITE_NAME="Smoke Testing"
          elif [ "$ENV_RUN_E2E_TESTS" = "None" ]; then
            TEST_SUITE_NAME="None"
          else
            TEST_SUITE_NAME="$ENV_RUN_E2E_TESTS"
          fi
          echo "TEST_SUITE_NAME=$TEST_SUITE_NAME" >> $GITHUB_OUTPUT
          echo "Test Suite: $TEST_SUITE_NAME"

      - name: Send Quota Failure Notification
        if: inputs.deploy_result == 'failure' && inputs.QUOTA_FAILED == 'true'
        shell: bash
        env:
          ENV_ACCELERATOR_NAME: ${{ env.accelerator_name }}
          ENV_GPT_MIN_CAPACITY: ${{ env.GPT_MIN_CAPACITY }}
          ENV_AZURE_REGIONS: ${{ vars.AZURE_REGIONS }}
          ENV_GITHUB_REPOSITORY: ${{ github.repository }}
          ENV_GITHUB_RUN_ID: ${{ github.run_id }}
        run: |
          RUN_URL="https://github.com/${ENV_GITHUB_REPOSITORY}/actions/runs/${ENV_GITHUB_RUN_ID}"
          EMAIL_BODY=$(cat <<EOF
          {
            "body": "<p>Dear Team,</p><p>We would like to inform you that the ${ENV_ACCELERATOR_NAME} deployment has failed due to insufficient quota in the requested regions.</p><p><strong>Issue Details:</strong><br>‚Ä¢ Quota check failed for GPT model<br>‚Ä¢ Required GPT Capacity: ${ENV_GPT_MIN_CAPACITY}<br>‚Ä¢ Checked Regions: ${ENV_AZURE_REGIONS}</p><p><strong>Run URL:</strong> <a href='${RUN_URL}'>${RUN_URL}</a></p><p>Please resolve the quota issue and retry the deployment.</p><p>Best regards,<br>Your Automation Team</p>",
            "subject": "${ENV_ACCELERATOR_NAME} Pipeline - Failed (Insufficient Quota)"
          }
          EOF
          )

          curl -X POST "${{ secrets.EMAILNOTIFICATION_LOGICAPP_URL_TA }}" \
            -H "Content-Type: application/json" \
            -d "$EMAIL_BODY" || echo "Failed to send quota failure notification"

      - name: Send Deployment Failure Notification
        if: inputs.deploy_result == 'failure' && inputs.QUOTA_FAILED != 'true'
        shell: bash
        env:
          ENV_ACCELERATOR_NAME: ${{ env.accelerator_name }}
          ENV_BACKEND_RUNTIME_STACK: ${{ env.BACKEND_RUNTIME_STACK }}
          ENV_EXP: ${{ env.EXP }}
          ENV_RESOURCE_GROUP_NAME: ${{ inputs.RESOURCE_GROUP_NAME }}
          ENV_GITHUB_REPOSITORY: ${{ github.repository }}
          ENV_GITHUB_RUN_ID: ${{ github.run_id }}
        run: |
          RUN_URL="https://github.com/${ENV_GITHUB_REPOSITORY}/actions/runs/${ENV_GITHUB_RUN_ID}"
          RESOURCE_GROUP="${ENV_RESOURCE_GROUP_NAME}"
          
          EMAIL_BODY=$(cat <<EOF
          {
            "body": "<p>Dear Team,</p><p>We would like to inform you that the ${ENV_ACCELERATOR_NAME} deployment process has encountered an issue and has failed to complete successfully.</p><p><strong>Deployment Details:</strong><br>‚Ä¢ Resource Group: ${RESOURCE_GROUP}<br>‚Ä¢ Backend Runtime: ${ENV_BACKEND_RUNTIME_STACK}<br>‚Ä¢ EXP Enabled: ${ENV_EXP}</p><p><strong>Run URL:</strong> <a href='${RUN_URL}'>${RUN_URL}</a></p><p>Please investigate the deployment failure at your earliest convenience.</p><p>Best regards,<br>Your Automation Team</p>",
            "subject": "${ENV_ACCELERATOR_NAME} Pipeline - Failed"
          }
          EOF
          )
          
          curl -X POST "${{ secrets.EMAILNOTIFICATION_LOGICAPP_URL_TA }}" \
            -H "Content-Type: application/json" \
            -d "$EMAIL_BODY" || echo "Failed to send deployment failure notification"

      - name: Send Success Notification
        if: inputs.deploy_result == 'success' && (inputs.e2e_test_result == 'skipped' || inputs.TEST_SUCCESS == 'true')
        shell: bash
        env:
          ENV_ACCELERATOR_NAME: ${{ env.accelerator_name }}
          ENV_BACKEND_RUNTIME_STACK: ${{ env.BACKEND_RUNTIME_STACK }}
          ENV_EXP: ${{ env.EXP }}
          ENV_WEB_APPURL: ${{ inputs.WEB_APPURL }}
          ENV_EXISTING_WEBAPP_URL: ${{ inputs.existing_webapp_url }}
          ENV_RESOURCE_GROUP_NAME: ${{ inputs.RESOURCE_GROUP_NAME }}
          ENV_TEST_REPORT_URL: ${{ inputs.TEST_REPORT_URL }}
          ENV_E2E_TEST_RESULT: ${{ inputs.e2e_test_result }}
          ENV_TEST_SUITE_NAME: ${{ steps.test_suite.outputs.TEST_SUITE_NAME }}
          ENV_GITHUB_REPOSITORY: ${{ github.repository }}
          ENV_GITHUB_RUN_ID: ${{ github.run_id }}
        run: |
          RUN_URL="https://github.com/${ENV_GITHUB_REPOSITORY}/actions/runs/${ENV_GITHUB_RUN_ID}"
          WEBAPP_URL="${ENV_WEB_APPURL:-$ENV_EXISTING_WEBAPP_URL}"
          RESOURCE_GROUP="${ENV_RESOURCE_GROUP_NAME}"
          TEST_REPORT_URL="${ENV_TEST_REPORT_URL}"
          TEST_SUITE_NAME="${ENV_TEST_SUITE_NAME}"
          
          if [ "$ENV_E2E_TEST_RESULT" = "skipped" ]; then
            EMAIL_BODY=$(cat <<EOF
          {
            "body": "<p>Dear Team,</p><p>We would like to inform you that the ${ENV_ACCELERATOR_NAME} deployment has completed successfully.</p><p><strong>Deployment Details:</strong><br>‚Ä¢ Resource Group: ${RESOURCE_GROUP}<br>‚Ä¢ Web App URL: <a href='${WEBAPP_URL}'>${WEBAPP_URL}</a><br>‚Ä¢ E2E Tests: Skipped (as configured)</p><p><strong>Configuration:</strong><br>‚Ä¢ Backend Runtime: ${ENV_BACKEND_RUNTIME_STACK}<br>‚Ä¢ EXP Enabled: ${ENV_EXP}</p><p><strong>Run URL:</strong> <a href='${RUN_URL}'>${RUN_URL}</a></p><p>Best regards,<br>Your Automation Team</p>",
            "subject": "${ENV_ACCELERATOR_NAME} Pipeline - Deployment Success"
          }
          EOF
            )
          else
            EMAIL_BODY=$(cat <<EOF
          {
            "body": "<p>Dear Team,</p><p>We would like to inform you that the ${ENV_ACCELERATOR_NAME} deployment and testing process has completed successfully.</p><p><strong>Deployment Details:</strong><br>‚Ä¢ Resource Group: ${RESOURCE_GROUP}<br>‚Ä¢ Web App URL: <a href='${WEBAPP_URL}'>${WEBAPP_URL}</a><br>‚Ä¢ E2E Tests: Passed ‚úÖ<br>‚Ä¢ Test Suite: ${TEST_SUITE_NAME}<br>‚Ä¢ Test Report: <a href='${TEST_REPORT_URL}'>View Report</a></p><p><strong>Configuration:</strong><br>‚Ä¢ Backend Runtime: ${ENV_BACKEND_RUNTIME_STACK}<br>‚Ä¢ EXP Enabled: ${ENV_EXP}</p><p><strong>Run URL:</strong> <a href='${RUN_URL}'>${RUN_URL}</a></p><p>Best regards,<br>Your Automation Team</p>",
            "subject": "${ENV_ACCELERATOR_NAME} Pipeline - Test Automation - Success"
          }
          EOF
            )
          fi
          
          curl -X POST "${{ secrets.EMAILNOTIFICATION_LOGICAPP_URL_TA }}" \
            -H "Content-Type: application/json" \
            -d "$EMAIL_BODY" || echo "Failed to send success notification"

      - name: Send Test Failure Notification
        if: inputs.deploy_result == 'success' && inputs.e2e_test_result != 'skipped' && inputs.TEST_SUCCESS != 'true'
        shell: bash
        env:
          ENV_ACCELERATOR_NAME: ${{ env.accelerator_name }}
          ENV_WEB_APPURL: ${{ inputs.WEB_APPURL }}
          ENV_EXISTING_WEBAPP_URL: ${{ inputs.existing_webapp_url }}
          ENV_RESOURCE_GROUP_NAME: ${{ inputs.RESOURCE_GROUP_NAME }}
          ENV_TEST_REPORT_URL: ${{ inputs.TEST_REPORT_URL }}
          ENV_TEST_SUITE_NAME: ${{ steps.test_suite.outputs.TEST_SUITE_NAME }}
          ENV_GITHUB_REPOSITORY: ${{ github.repository }}
          ENV_GITHUB_RUN_ID: ${{ github.run_id }}
        run: |
          RUN_URL="https://github.com/${ENV_GITHUB_REPOSITORY}/actions/runs/${ENV_GITHUB_RUN_ID}"
          TEST_REPORT_URL="${ENV_TEST_REPORT_URL}"
          WEBAPP_URL="${ENV_WEB_APPURL:-$ENV_EXISTING_WEBAPP_URL}"
          RESOURCE_GROUP="${ENV_RESOURCE_GROUP_NAME}"
          TEST_SUITE_NAME="${ENV_TEST_SUITE_NAME}"
          
          EMAIL_BODY=$(cat <<EOF
          {
            "body": "<p>Dear Team,</p><p>We would like to inform you that ${ENV_ACCELERATOR_NAME} accelerator test automation process has encountered issues and failed to complete successfully.</p><p><strong>Deployment Details:</strong><br>‚Ä¢ Resource Group: ${RESOURCE_GROUP}<br>‚Ä¢ Web App URL: <a href='${WEBAPP_URL}'>${WEBAPP_URL}</a><br>‚Ä¢ Deployment Status: ‚úÖ Success<br>‚Ä¢ E2E Tests: ‚ùå Failed<br>‚Ä¢ Test Suite: ${TEST_SUITE_NAME}</p><p><strong>Test Details:</strong><br>‚Ä¢ Test Report: <a href='${TEST_REPORT_URL}'>View Report</a></p><p><strong>Run URL:</strong> <a href='${RUN_URL}'>${RUN_URL}</a></p><p>Please investigate the matter at your earliest convenience.</p><p>Best regards,<br>Your Automation Team</p>",
            "subject": "${ENV_ACCELERATOR_NAME} Pipeline - Test Automation - Failed"
          }
          EOF
          )

          curl -X POST "${{ secrets.EMAILNOTIFICATION_LOGICAPP_URL_TA }}" \
            -H "Content-Type: application/json" \
            -d "$EMAIL_BODY" || echo "Failed to send test failure notification"

      - name: Send Existing URL Success Notification
        if: inputs.deploy_result == 'skipped' && inputs.existing_webapp_url != '' && inputs.e2e_test_result == 'success' && (inputs.TEST_SUCCESS == 'true' || inputs.TEST_SUCCESS == '')
        shell: bash
        env:
          ENV_ACCELERATOR_NAME: ${{ env.accelerator_name }}
          ENV_EXISTING_WEBAPP_URL: ${{ inputs.existing_webapp_url }}
          ENV_TEST_REPORT_URL: ${{ inputs.TEST_REPORT_URL }}
          ENV_TEST_SUITE_NAME: ${{ steps.test_suite.outputs.TEST_SUITE_NAME }}
          ENV_GITHUB_REPOSITORY: ${{ github.repository }}
          ENV_GITHUB_RUN_ID: ${{ github.run_id }}
        run: |
          RUN_URL="https://github.com/${ENV_GITHUB_REPOSITORY}/actions/runs/${ENV_GITHUB_RUN_ID}"
          EXISTING_URL="${ENV_EXISTING_WEBAPP_URL}"
          TEST_REPORT_URL="${ENV_TEST_REPORT_URL}"
          TEST_SUITE_NAME="${ENV_TEST_SUITE_NAME}"
          
          EMAIL_BODY=$(cat <<EOF
          {
            "body": "<p>Dear Team,</p><p>The ${ENV_ACCELERATOR_NAME} pipeline executed against the <strong>existing WebApp URL</strong> and testing process has completed successfully.</p><p><strong>Test Results:</strong><br>‚Ä¢ Status: ‚úÖ Passed<br>‚Ä¢ Test Suite: ${TEST_SUITE_NAME}<br>${TEST_REPORT_URL:+‚Ä¢ Test Report: <a href='${TEST_REPORT_URL}'>View Report</a>}<br>‚Ä¢ Target URL: <a href='${EXISTING_URL}'>${EXISTING_URL}</a></p><p><strong>Deployment:</strong> Skipped</p><p><strong>Run URL:</strong> <a href='${RUN_URL}'>${RUN_URL}</a></p><p>Best regards,<br>Your Automation Team</p>",
            "subject": "${ENV_ACCELERATOR_NAME} Pipeline - Test Automation Passed (Existing URL)"
          }
          EOF
          )

          curl -X POST "${{ secrets.EMAILNOTIFICATION_LOGICAPP_URL_TA }}" \
            -H "Content-Type: application/json" \
            -d "$EMAIL_BODY" || echo "Failed to send existing URL success notification"

      - name: Send Existing URL Test Failure Notification
        if: inputs.deploy_result == 'skipped' && inputs.existing_webapp_url != '' && inputs.e2e_test_result == 'failure'
        shell: bash
        env:
          ENV_ACCELERATOR_NAME: ${{ env.accelerator_name }}
          ENV_EXISTING_WEBAPP_URL: ${{ inputs.existing_webapp_url }}
          ENV_TEST_REPORT_URL: ${{ inputs.TEST_REPORT_URL }}
          ENV_TEST_SUITE_NAME: ${{ steps.test_suite.outputs.TEST_SUITE_NAME }}
          ENV_GITHUB_REPOSITORY: ${{ github.repository }}
          ENV_GITHUB_RUN_ID: ${{ github.run_id }}
        run: |
          RUN_URL="https://github.com/${ENV_GITHUB_REPOSITORY}/actions/runs/${ENV_GITHUB_RUN_ID}"
          EXISTING_URL="${ENV_EXISTING_WEBAPP_URL}"
          TEST_REPORT_URL="${ENV_TEST_REPORT_URL}"
          TEST_SUITE_NAME="${ENV_TEST_SUITE_NAME}"
          
          EMAIL_BODY=$(cat <<EOF
          {
            "body": "<p>Dear Team,</p><p>The ${ENV_ACCELERATOR_NAME} pipeline executed against the <strong>existing WebApp URL</strong> and the test automation has encountered issues and failed to complete successfully.</p><p><strong>Failure Details:</strong><br>‚Ä¢ Target URL: <a href='${EXISTING_URL}'>${EXISTING_URL}</a><br>${TEST_REPORT_URL:+‚Ä¢ Test Report: <a href='${TEST_REPORT_URL}'>View Report</a>}<br>‚Ä¢ Test Suite: ${TEST_SUITE_NAME}<br>‚Ä¢ Deployment: Skipped</p><p><strong>Run URL:</strong> <a href='${RUN_URL}'>${RUN_URL}</a></p><p>Best regards,<br>Your Automation Team</p>",
            "subject": "${ENV_ACCELERATOR_NAME} Pipeline - Test Automation Failed (Existing URL)"
          }
          EOF
          )

          curl -X POST "${{ secrets.EMAILNOTIFICATION_LOGICAPP_URL_TA }}" \
            -H "Content-Type: application/json" \
            -d "$EMAIL_BODY" || echo "Failed to send existing URL test failure notification"
