name: ðŸš€ Deploy to Production

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - prod
      confirm:
        description: 'Type "deploy" to confirm production deployment'
        required: false
        type: string

env:
  AZURE_CLIENT_ID: ${{ vars.AZURE_CLIENT_ID }}
  AZURE_TENANT_ID: ${{ vars.AZURE_TENANT_ID }}
  AZURE_SUBSCRIPTION_ID: ${{ vars.AZURE_SUBSCRIPTION_ID }}

jobs:
  # ===================================
  # Validation
  # ===================================
  validate:
    name: âœ… Validate
    runs-on: ubuntu-latest
    outputs:
      environment: ${{ steps.set-env.outputs.environment }}
    
    steps:
      - name: Determine environment
        id: set-env
        run: |
          if [[ "${{ github.event_name }}" == "push" && "${{ github.ref }}" == refs/tags/v* ]]; then
            echo "environment=prod" >> $GITHUB_OUTPUT
          elif [[ "${{ github.event.inputs.environment }}" == "prod" ]]; then
            if [[ "${{ github.event.inputs.confirm }}" != "deploy" ]]; then
              echo "âŒ Production deployment requires confirmation. Type 'deploy' to confirm."
              exit 1
            fi
            echo "environment=prod" >> $GITHUB_OUTPUT
          else
            echo "environment=${{ github.event.inputs.environment || 'staging' }}" >> $GITHUB_OUTPUT
          fi
      
      - name: Summary
        run: |
          echo "## ðŸŽ¯ Deployment Target" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment**: ${{ steps.set-env.outputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Trigger**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Ref**: ${{ github.ref }}" >> $GITHUB_STEP_SUMMARY

  # ===================================
  # Build & Test
  # ===================================
  build:
    name: ðŸ”¨ Build & Test
    needs: validate
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install & Test Python
        run: |
          cd src/api
          pip install -r requirements.txt
          pip install pytest pytest-asyncio
          python -m pytest tests/ -v --tb=short || true
        env:
          DEMO_MODE: "true"
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: src/web/package-lock.json
      
      - name: Build frontend
        run: |
          cd src/web
          npm ci
          npm run build

  # ===================================
  # Security Scan
  # ===================================
  security:
    name: ðŸ”’ Security Scan
    needs: validate
    runs-on: ubuntu-latest
    permissions:
      security-events: write
      contents: read
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@0.28.0
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'table'
          severity: 'CRITICAL,HIGH'
          exit-code: '0'  # Don't fail, just report

  # ===================================
  # Deploy to Staging
  # ===================================
  deploy-staging:
    name: ðŸ§ª Deploy to Staging
    needs: [validate, build, security]
    if: needs.validate.outputs.environment == 'staging' || needs.validate.outputs.environment == 'prod'
    runs-on: ubuntu-latest
    environment:
      name: staging
      url: ${{ steps.deploy.outputs.url }}
    permissions:
      id-token: write
      contents: read
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Install azd
        uses: Azure/setup-azd@v2
      
      - name: Azure Login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ env.AZURE_CLIENT_ID }}
          tenant-id: ${{ env.AZURE_TENANT_ID }}
          subscription-id: ${{ env.AZURE_SUBSCRIPTION_ID }}
      
      - name: azd auth login
        run: azd auth login --client-id ${{ env.AZURE_CLIENT_ID }} --federated-credential-provider github
      
      - name: Deploy to Staging
        id: deploy
        run: |
          azd up --no-prompt
          echo "url=$(azd env get-values | grep -E '^WEB_URI=' | cut -d= -f2 | tr -d '"')" >> $GITHUB_OUTPUT
        env:
          AZURE_ENV_NAME: staging
      
      - name: Smoke Test
        run: |
          API_URL=$(azd env get-values | grep -E '^API_URI=' | cut -d= -f2 | tr -d '"')
          echo "Testing API: $API_URL"
          curl -sf "$API_URL/health" || echo "Health check skipped"
        continue-on-error: true

  # ===================================
  # Deploy to Production
  # ===================================
  deploy-prod:
    name: ðŸš€ Deploy to Production
    needs: [validate, deploy-staging]
    if: needs.validate.outputs.environment == 'prod'
    runs-on: ubuntu-latest
    environment:
      name: prod
      url: ${{ steps.deploy.outputs.url }}
    permissions:
      id-token: write
      contents: read
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Install azd
        uses: Azure/setup-azd@v2
      
      - name: Azure Login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ env.AZURE_CLIENT_ID }}
          tenant-id: ${{ env.AZURE_TENANT_ID }}
          subscription-id: ${{ env.AZURE_SUBSCRIPTION_ID }}
      
      - name: azd auth login
        run: azd auth login --client-id ${{ env.AZURE_CLIENT_ID }} --federated-credential-provider github
      
      - name: Deploy to Production
        id: deploy
        run: |
          azd up --no-prompt
          echo "url=$(azd env get-values | grep -E '^WEB_URI=' | cut -d= -f2 | tr -d '"')" >> $GITHUB_OUTPUT
        env:
          AZURE_ENV_NAME: prod
      
      - name: Production Smoke Test
        run: |
          API_URL=$(azd env get-values | grep -E '^API_URI=' | cut -d= -f2 | tr -d '"')
          WEB_URL=$(azd env get-values | grep -E '^WEB_URI=' | cut -d= -f2 | tr -d '"')
          echo "## ðŸŽ‰ Production Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Endpoint | URL |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-----|" >> $GITHUB_STEP_SUMMARY
          echo "| API | $API_URL |" >> $GITHUB_STEP_SUMMARY
          echo "| Web | $WEB_URL |" >> $GITHUB_STEP_SUMMARY
        continue-on-error: true

  # ===================================
  # Notify
  # ===================================
  notify:
    name: ðŸ“¢ Notify
    needs: [validate, deploy-staging, deploy-prod]
    if: always()
    runs-on: ubuntu-latest
    
    steps:
      - name: Deployment Summary
        run: |
          echo "## ðŸ“‹ Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Stage | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Validation | ${{ needs.validate.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Staging | ${{ needs.deploy-staging.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Production | ${{ needs.deploy-prod.result }} |" >> $GITHUB_STEP_SUMMARY
