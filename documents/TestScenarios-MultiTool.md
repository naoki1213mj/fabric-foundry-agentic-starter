# マルチツール統合テストシナリオ

> **目的**: エージェントが1ターン内で複数のツール（SQL + Doc + Web + MCP）を組み合わせて回答できることを検証する
>
> **最終更新**: 2026年2月5日

---

## 📊 利用可能なツール一覧

### 4つのツールカテゴリ

```
┌─────────────────────────────────────────────────────────────────────────────────────────────┐
│                              AVAILABLE TOOLS                                                 │
│                                                                                              │
│  ┌─────────────────────┐  ┌─────────────────────┐  ┌─────────────────────┐                 │
│  │  SQL Tool           │  │  Doc Tool           │  │  Web Tool           │                 │
│  │  run_sql_query      │  │  search_documents   │  │  search_web         │                 │
│  │                     │  │                     │  │                     │                 │
│  │  データソース:       │  │  データソース:       │  │  データソース:       │                 │
│  │  Fabric SQL DB      │  │  Foundry IQ         │  │  Bing Grounding     │                 │
│  │                     │  │  (Agentic RAG)      │  │                     │                 │
│  │  用途:              │  │                     │  │  用途:              │                 │
│  │  ├─ 売上データ      │  │  用途:              │  │  ├─ 市場動向       │                 │
│  │  ├─ 顧客データ      │  │  ├─ 製品仕様書     │  │  ├─ 競合情報       │                 │
│  │  ├─ 在庫データ      │  │  ├─ 技術資料       │  │  ├─ 業界ニュース   │                 │
│  │  └─ 注文データ      │  │  └─ 社内文書       │  │  └─ 規制・法律     │                 │
│  └─────────────────────┘  └─────────────────────┘  └─────────────────────┘                 │
│                                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────────────────────┐    │
│  │  MCP Tools (16 Business Analytics Tools / 4 Categories)                             │    │
│  │                                                                                      │    │
│  │  売上分析 (5):                                                                      │    │
│  │  calculate_yoy_growth / calculate_mom_growth / calculate_moving_average              │    │
│  │  calculate_abc_analysis / calculate_sales_forecast                                  │    │
│  │                                                                                      │    │
│  │  顧客分析 (4):                                                                      │    │
│  │  calculate_rfm_score / classify_customer_segment / calculate_clv                    │    │
│  │  recommend_next_action                                                              │    │
│  │                                                                                      │    │
│  │  在庫分析 (3):                                                                      │    │
│  │  calculate_inventory_turnover / calculate_reorder_point                              │    │
│  │  identify_slow_moving_inventory                                                      │    │
│  │                                                                                      │    │
│  │  製品比較 (4):                                                                      │    │
│  │  compare_products / calculate_price_performance / suggest_alternatives               │    │
│  │  calculate_bundle_discount                                                          │    │
│  └─────────────────────────────────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────────────────────────────────┘
```

### ツール組み合わせパターン

| パターン | ツール | 用途 |
|----------|--------|------|
| **SQL + Doc** | 売上データ + 製品仕様 | 製品分析・比較 |
| **SQL + Web** | 売上データ + 市場情報 | 競合分析・市場調査 |
| **SQL + MCP** | 売上データ + 分析計算 | KPI分析・レポート |
| **Doc + Web** | 製品仕様 + 業界情報 | 製品ポジショニング |
| **SQL + Doc + Web** | 全内部データ + 外部情報 | 総合分析 |
| **SQL + Doc + MCP** | 全内部データ + 高度分析 | 経営ダッシュボード |
| **ALL (SQL + Doc + Web + MCP)** | 全ツール統合 | エグゼクティブレポート |

---

## 🎯 テストシナリオ

### シナリオ 1: 製品比較分析（SQL + Doc）

**難易度**: ⭐⭐（中級）

**クエリ**:

```
Mountain-100とMountain-200の売上データを比較し、
製品仕様書から各製品の特徴を取得して、
どちらがコストパフォーマンスに優れているか分析してください。
```

**期待される処理フロー**:

1. `run_sql_query`: Mountain-100の売上・価格データを取得
2. `run_sql_query`: Mountain-200の売上・価格データを取得
3. `search_documents`: Mountain-100の製品仕様を取得
4. `search_documents`: Mountain-200の製品仕様を取得
5. 統合分析と比較レポート生成

**期待される回答内容**:

| 項目 | Mountain-100 | Mountain-200 | 優位性 |
|------|--------------|--------------|--------|
| 価格 | $3,399 | $2,499 | Mountain-200 |
| 売上数量 | 150台 | 280台 | Mountain-200 |
| 重量 | 13.5kg | 14.2kg | Mountain-100 |
| フレーム素材 | カーボン | アルミ | Mountain-100 |
| コスパスコア | 8.2 | 9.1 | Mountain-200 |

---

### シナリオ 2: 競合分析レポート（SQL + Web）

**難易度**: ⭐⭐（中級）

**クエリ**:

```
当社のE-Bikeカテゴリの2025年売上実績を取得し、
E-Bike市場の最新動向と競合他社の状況をWeb検索して、
当社の市場ポジションと今後の戦略を提案してください。
```

**期待される処理フロー**:

1. `run_sql_query`: E-Bikeカテゴリの2025年売上を取得
2. `search_web`: "E-Bike market trends 2025"
3. `search_web`: "E-Bike competitors market share"
4. 市場分析と戦略提案

**期待される回答内容**:

- 当社E-Bike売上: $XXX,XXX（前年比 +XX%）
- グローバルE-Bike市場規模: $XXB（CAGR XX%）
- 主要競合: 社名A（シェアXX%）、社名B（シェアXX%）
- 当社推定シェア: X.X%
- 戦略提案:
  1. 高価格帯セグメント強化
  2. オンライン販売チャネル拡大
  3. バッテリー技術への投資

---

### シナリオ 3: 製品仕様と業界規制（Doc + Web）

**難易度**: ⭐⭐（中級）

**クエリ**:

```
当社のRoad Bike製品の安全規格への適合状況を製品仕様書から確認し、
EUの最新自転車安全規制（EN規格）についてWeb検索して、
コンプライアンスリスクを評価してください。
```

**期待される処理フロー**:

1. `search_documents`: Road Bike製品の安全規格情報
2. `search_documents`: 製品認証・適合証明書
3. `search_web`: "EU bicycle safety regulations EN ISO 4210 2025"
4. `search_web`: "E-Bike battery regulations EU 2025"
5. コンプライアンス評価レポート

**期待される回答内容**:

- 当社製品の現行認証: EN 14764（適合）、JIS D9111（適合）
- 2025年EU新規制の変更点: バッテリー安全基準強化
- リスク評価:
  - 低リスク: 一般自転車（現行認証で対応可能）
  - 中リスク: E-Bike（バッテリー基準の更新必要）
- 推奨アクション: 2025年Q3までにバッテリー認証更新

---

### シナリオ 4: 総合KPIレポート（SQL + MCP）

**難易度**: ⭐⭐⭐（上級）

**クエリ**:

```
2025年1月の経営KPIレポートを作成してください。
売上データを取得して前年比成長率を計算し、
顧客RFM分析と在庫回転率も含めてダッシュボード形式でまとめてください。
```

**期待される処理フロー**:

1. `run_sql_query`: 2025年1月の売上サマリー
2. `run_sql_query`: 2024年1月の売上サマリー（比較用）
3. `calculate_yoy_growth`: 前年比成長率計算
4. `run_sql_query`: 顧客購買データ
5. `calculate_rfm_score`: RFMセグメント分析
6. `run_sql_query`: 在庫データ
7. `calculate_inventory_turnover`: 在庫回転率分析

**期待される回答内容**:

```markdown
# 📊 2025年1月 経営KPIダッシュボード

## 売上サマリー
| 指標 | 今月 | 前年同月 | 成長率 |
|------|------|----------|--------|
| 総売上 | $1,234,567 | $1,098,765 | +12.3% |
| 注文数 | 1,543 | 1,321 | +16.8% |
| 平均注文額 | $800 | $832 | -3.8% |

## 顧客セグメント分布
| セグメント | 顧客数 | 売上構成比 |
|------------|--------|------------|
| Champions | 120 | 35% |
| Loyal | 350 | 28% |
| At Risk | 89 | 15% |
| その他 | 1,200 | 22% |

## 在庫健全性
- 平均回転率: 4.2回/年
- 滞留在庫: 23製品（$45,000相当）
- 発注点見直し推奨: 15製品
```

---

### シナリオ 5: 製品戦略立案（SQL + Doc + Web）

**難易度**: ⭐⭐⭐（上級）

**クエリ**:

```
Mountain Bikeカテゴリの売上トップ3製品について、
売上データ、製品仕様、そして市場での評判（Web検索）を
総合的に分析し、次期製品開発の方向性を提案してください。
```

**期待される処理フロー**:

1. `run_sql_query`: Mountain Bike売上TOP3を取得
2. `search_documents`: TOP3各製品の仕様書
3. `search_web`: "{製品名} reviews 2025"
4. `search_web`: "Mountain bike trends 2025 consumer preferences"
5. 総合分析と製品戦略提案

**期待される回答内容**:

```markdown
# Mountain Bike 製品戦略レポート

## 売上TOP3製品分析

### 1. Mountain-200 (売上 $699,720)
**売上データ**: 280台、平均単価 $2,499
**製品仕様**: アルミフレーム、27.5インチ、油圧ディスク
**市場評価**: ★4.5/5（コスパ高評価、重量に不満の声）

### 2. Mountain-100 (売上 $509,850)
**売上データ**: 150台、平均単価 $3,399
**製品仕様**: カーボンフレーム、29インチ、XTRコンポ
**市場評価**: ★4.7/5（軽量・高性能、価格がネック）

### 3. Mountain-300 (売上 $398,400)
**売上データ**: 320台、平均単価 $1,245
**製品仕様**: スチールフレーム、26インチ、機械式ディスク
**市場評価**: ★4.0/5（入門用として人気、耐久性に課題）

## 市場トレンド
- 軽量化への需要継続
- 電動アシスト（E-MTB）市場拡大
- サステナビリティへの関心（リサイクル素材）

## 次期製品開発提案
1. **Mountain-250（新規）**: Mountain-200の軽量版（カーボン/アルミハイブリッド）
2. **E-Mountain-100**: Mountain-100のE-MTB版
3. Mountain-300のフレーム素材をリサイクルアルミに変更
```

---

### シナリオ 6: 経営会議向けエグゼクティブレポート（ALL: SQL + Doc + Web + MCP）

**難易度**: ⭐⭐⭐⭐（エキスパート）

**クエリ**:

```
経営会議向けの月次エグゼクティブレポートを作成してください。
以下を含めてください：

1. 売上・利益サマリー（前年比・前月比付き）
2. カテゴリ別ABC分析と重点商品
3. 顧客セグメント分析とCLV上位顧客
4. 在庫健全性と発注推奨
5. 製品仕様書から主力製品の特徴
6. 市場動向と競合情報（Web検索）
7. 経営への提言

グラフを多用して視覚的にわかりやすくしてください。
```

**期待される処理フロー**:

1. `run_sql_query`: 月次売上・利益データ
2. `run_sql_query`: 前年同月データ（比較用）
3. `calculate_yoy_growth`: 前年比計算
4. `run_sql_query`: カテゴリ別売上
5. `calculate_abc_analysis`: ABC分析（売上パレート）
6. `run_sql_query`: 顧客購買データ
7. `calculate_rfm_score`: RFMセグメント
8. `calculate_clv`: CLV計算
9. `run_sql_query`: 在庫データ
10. `calculate_inventory_turnover`: 在庫回転率・発注点
11. `search_documents`: 主力製品仕様
12. `search_web`: "bicycle industry trends 2025"
13. `search_web`: "bicycle market competitors analysis"
14. 統合レポート生成

**期待される回答内容**:

```markdown
# 📊 エグゼクティブレポート（2025年1月）

## 1. 売上・利益サマリー

| 指標 | 当月 | 前年同月 | YoY成長率 | 前月 | MoM成長率 |
|------|------|----------|-----------|------|-----------|
| 売上高 | $1,234,567 | $1,098,765 | **+12.3%** | $1,198,234 | +3.0% |
| 粗利益 | $370,370 | $329,630 | +12.4% | $359,470 | +3.0% |
| 粗利率 | 30.0% | 30.0% | ±0% | 30.0% | ±0% |

[売上推移グラフ - 12ヶ月]

## 2. カテゴリ別ABC分析

| ランク | カテゴリ | 売上 | 構成比 | 累積 |
|--------|----------|------|--------|------|
| A | Mountain Bike | $450,000 | 36% | 36% |
| A | Road Bike | $350,000 | 28% | 64% |
| A | E-Bike | $200,000 | 16% | 80% |
| B | Accessories | $120,000 | 10% | 90% |
| C | その他 | $114,567 | 10% | 100% |

**重点管理**: Mountain Bike、Road Bike、E-Bike の在庫切れ防止

## 3. 顧客セグメント分析

### セグメント分布
| セグメント | 顧客数 | 売上構成比 | CLV平均 |
|------------|--------|------------|---------|
| Champions | 120 (8%) | 35% | $15,000 |
| Loyal | 350 (23%) | 28% | $8,000 |
| At Risk | 89 (6%) | 15% | $5,000 |
| New | 200 (13%) | 12% | $2,000 |
| Others | 750 (50%) | 10% | $1,500 |

### CLV上位顧客（維持施策対象）
| 顧客 | セグメント | 年間購入額 | CLV | 推奨アクション |
|------|------------|------------|-----|----------------|
| A社 | Champions | $50,000 | $150,000 | VIPプログラム |
| B氏 | Champions | $35,000 | $105,000 | 限定イベント招待 |
| C社 | Loyal | $25,000 | $75,000 | アップグレード提案 |

## 4. 在庫健全性

| 指標 | 値 | 評価 |
|------|-----|------|
| 平均在庫回転率 | 4.2回/年 | 🟢 良好 |
| 滞留在庫（90日超） | 23製品 | 🟡 要注意 |
| 滞留在庫金額 | $45,000 | |
| 欠品リスク製品 | 5製品 | 🔴 緊急対応 |

**発注推奨**: Mountain-200（在庫15台、発注点30台）

## 5. 主力製品特徴（仕様書より）

| 製品 | フレーム | 重量 | 特徴 |
|------|----------|------|------|
| Mountain-200 | アルミ6061 | 14.2kg | コスパ最強、初中級向け |
| Road-100 | カーボンT800 | 7.8kg | レース対応、上級者向け |
| E-Bike-500 | アルミ | 22kg | 500Wモーター、航続80km |

## 6. 市場動向・競合情報

### 業界トレンド（Web検索結果）
- グローバル自転車市場: $XX billion（CAGR 6.2%）
- E-Bike成長率: **+18%**（最も成長）
- サステナビリティ: リサイクル素材への関心高
- D2C販売: オンライン比率30%超

### 競合動向
| 競合 | 市場シェア | 最近の動き |
|------|------------|------------|
| Giant | 12% | 新E-Bikeライン発表 |
| Trek | 10% | サステナビリティ宣言 |
| Specialized | 8% | D2C強化 |

## 7. 経営への提言

### 短期（Q1）
1. **欠品対策**: Mountain-200の緊急発注（発注点割れ）
2. **At Risk顧客**: 89名へのリテンションキャンペーン実施
3. **滞留在庫**: 23製品のプロモーション販売

### 中期（Q2-Q3）
4. **E-Bike強化**: 市場成長率18%に対応、ラインナップ拡充
5. **D2C推進**: オンライン販売比率20%→30%目標

### 長期（2025年度）
6. **サステナビリティ**: リサイクル素材製品の開発着手
7. **グローバル展開**: アジア市場（成長率高）への進出検討
```

---

### シナリオ 7: 地域×季節分析（SQL + MCP × 2）

**難易度**: ⭐⭐⭐（上級）

**クエリ**:

```
過去2年間のデータから、地域別の売上パフォーマンスと
季節性トレンドを分析し、各地域への最適な販促タイミングを
提案してください。
```

**期待される処理フロー**:

1. `run_sql_query`: 地域別・月別売上データ（24ヶ月）
2. `calculate_yoy_growth`: 地域別KPI計算
3. `calculate_moving_average`: 季節性指数計算
4. クロス分析（地域×季節）

**期待される回答内容**:

| 地域 | 年間売上 | 成長率 | ピーク月 | 推奨施策 |
|------|----------|--------|----------|----------|
| 北米 | $500K | +15% | 4-6月 | 春キャンペーン |
| 欧州 | $350K | +8% | 5-7月 | 夏前プロモ |
| アジア | $200K | +25% | 3-5月 | 新生活需要 |

---

### シナリオ 8: 顧客インサイト深掘り（SQL + Doc + MCP）

**難易度**: ⭐⭐⭐（上級）

**クエリ**:

```
VIP顧客（年間購入額上位10名）について、
購買データからRFM分析を行い、
過去の購入製品の仕様書を確認して、
次に推奨すべき製品を提案してください。
```

**期待される処理フロー**:

1. `run_sql_query`: VIP顧客TOP10と購買履歴
2. `calculate_rfm_score`: RFMスコア計算
3. `run_sql_query`: 各顧客の購入製品一覧
4. `search_documents`: 購入製品の仕様
5. `search_documents`: 関連製品・上位モデルの仕様
6. 推奨製品マッチング

**期待される回答内容**:

| VIP顧客 | 過去購入 | RFMスコア | 推奨製品 | 理由 |
|---------|----------|-----------|----------|------|
| A氏 | Mountain-200 | 555 | Mountain-100 | アップグレード需要、カーボン志向 |
| B社 | Road-300 | 544 | Road-100 | レース参加予定、高性能ニーズ |

---

## 📋 マルチターンシナリオ

### マルチターン 1: 段階的な市場分析

**ターン1**:

```
ユーザー: E-Bikeカテゴリの売上推移を教えて
```

→ `run_sql_query` で売上データ取得

**ターン2**:

```
ユーザー: E-Bikeの製品仕様も確認して
```

→ `search_documents` で仕様書取得

**ターン3**:

```
ユーザー: 市場全体の動向も調べて
```

→ `search_web` で市場情報取得

**ターン4**:

```
ユーザー: これらを総合して戦略レポートにまとめて
```

→ 全ての結果を統合してレポート生成

---

### マルチターン 2: 問題発見→原因分析→解決策

**ターン1**:

```
ユーザー: 在庫回転率が低い製品を特定して
```

→ `run_sql_query` + `identify_slow_moving_inventory`

**ターン2**:

```
ユーザー: それらの製品の仕様を確認して
```

→ `search_documents` で仕様確認

**ターン3**:

```
ユーザー: 競合製品の状況もWeb検索して
```

→ `search_web` で競合調査

**ターン4**:

```
ユーザー: 滞留の原因と解決策を提案して
```

→ 総合分析と解決策提案

---

## ✅ 検証チェックリスト

各シナリオで以下を確認：

- [ ] **複数ツールが正しく呼び出されている**（ログで確認）
- [ ] **ツール間でデータが正しく受け渡されている**
- [ ] **結果が1つの統合された回答にまとまっている**
- [ ] **グラフ（Chart.js JSON）が適切に生成されている**
- [ ] **引用元が明記されている**（Web検索結果、ドキュメント名）
- [ ] **経営判断に役立つ示唆が含まれている**
- [ ] **レスポンス時間が許容範囲内**（目安: 60秒以内）

---

## 🚀 クイックテストコマンド

### シナリオ 1: 製品比較分析（SQL + Doc）

```powershell
$body = @{
    query = "Mountain-100とMountain-200の売上データを比較し、製品仕様書から各製品の特徴を取得して、どちらがコストパフォーマンスに優れているか分析してください"
    conversation_id = "test-sql-doc-001"
    agent_mode = "multi_tool"
} | ConvertTo-Json -Depth 10

Invoke-RestMethod -Uri "https://api-daj6dri4yf3k3z.azurewebsites.net/api/chat" `
    -Method POST -ContentType "application/json; charset=utf-8" `
    -Body ([System.Text.Encoding]::UTF8.GetBytes($body)) -TimeoutSec 120
```

### シナリオ 2: 競合分析レポート（SQL + Web）

```powershell
$body = @{
    query = "当社のE-Bikeカテゴリの2025年売上実績を取得し、E-Bike市場の最新動向と競合他社の状況をWeb検索して、当社の市場ポジションと今後の戦略を提案してください"
    conversation_id = "test-sql-web-001"
    agent_mode = "multi_tool"
} | ConvertTo-Json -Depth 10

Invoke-RestMethod -Uri "https://api-daj6dri4yf3k3z.azurewebsites.net/api/chat" `
    -Method POST -ContentType "application/json; charset=utf-8" `
    -Body ([System.Text.Encoding]::UTF8.GetBytes($body)) -TimeoutSec 120
```

### シナリオ 5: 製品戦略立案（SQL + Doc + Web）

```powershell
$body = @{
    query = "Mountain Bikeカテゴリの売上トップ3製品について、売上データ、製品仕様、そして市場での評判（Web検索）を総合的に分析し、次期製品開発の方向性を提案してください"
    conversation_id = "test-sql-doc-web-001"
    agent_mode = "multi_tool"
} | ConvertTo-Json -Depth 10

Invoke-RestMethod -Uri "https://api-daj6dri4yf3k3z.azurewebsites.net/api/chat" `
    -Method POST -ContentType "application/json; charset=utf-8" `
    -Body ([System.Text.Encoding]::UTF8.GetBytes($body)) -TimeoutSec 180
```

### シナリオ 6: エグゼクティブレポート（ALL）

```powershell
$body = @{
    query = @"
経営会議向けの月次エグゼクティブレポートを作成してください。
以下を含めてください：
1. 売上・利益サマリー（前年比・前月比付き）
2. カテゴリ別ABC分析と重点商品
3. 顧客セグメント分析とCLV上位顧客
4. 在庫健全性と発注推奨
5. 製品仕様書から主力製品の特徴
6. 市場動向と競合情報（Web検索）
7. 経営への提言
グラフを多用して視覚的にわかりやすくしてください。
"@
    conversation_id = "test-all-tools-001"
    agent_mode = "multi_tool"
} | ConvertTo-Json -Depth 10

Invoke-RestMethod -Uri "https://api-daj6dri4yf3k3z.azurewebsites.net/api/chat" `
    -Method POST -ContentType "application/json; charset=utf-8" `
    -Body ([System.Text.Encoding]::UTF8.GetBytes($body)) -TimeoutSec 300
```

---

## 📝 注意事項

1. **タイムアウト設定**: 全ツール統合シナリオは処理に時間がかかるため、タイムアウトを180〜300秒に設定
2. **トークン制限**: 大量のデータを扱う場合、結果が切り詰められる可能性あり
3. **ツール依存関係**:
   - SQL Tool: Fabric SQL Database が稼働していること
   - Doc Tool: AI Search インデックスにドキュメントが登録されていること
   - Web Tool: Bing Grounding コネクションが有効であること
   - MCP Tools: MCP Server (Azure Functions) が稼働していること
4. **コスト考慮**: GPT-5の複数回呼び出しはトークンコストが高い

---

## 関連ドキュメント

- [Testing-Guide.md](Testing-Guide.md) - テスト運用ガイド
- [TechnicalArchitecture.md](TechnicalArchitecture.md) - 技術アーキテクチャ
- [Agent-Architecture.md](Agent-Architecture.md) - エージェントアーキテクチャ
- [DEMO.md](../DEMO.md) - デモシナリオ
